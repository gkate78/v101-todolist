{#
    Todo List Main Page Template
    
    This template extends base.html and defines the todo list interface.
    It uses Jinja2 templating to display todos from the database.
    
    Key concepts:
    - {% extends %}: Inherits from base.html
    - {% block %}: Defines sections that can be filled by child templates
    - {{ variable }}: Outputs a variable value
    - {% for %}: Loops through a list
    - {% if %}: Conditional rendering
#}

{% extends "base.html" %}

{% block title %}Todo List - Home{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl sm:text-4xl font-hand font-bold text-black mb-2">
            My Todo List
        </h1>
        <p class="text-base sm:text-lg text-gray-600 font-sans">
            Add, complete, and manage your tasks
        </p>
    </div>
    
    <!-- Add Todo Form -->
    <div class="bg-white border-2 border-black rounded-lg shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-hand font-bold text-black mb-4 sm:mb-6">
            Add New Todo
        </h2>
        
        <form id="todoForm" class="space-y-4">
            <!-- Title Input -->
            <div>
                <label for="todoTitle" class="block text-sm font-medium text-black mb-2 font-hand">
                    What do you need to do?
                </label>
                <input 
                    type="text" 
                    id="todoTitle" 
                    name="title"
                    class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans"
                    placeholder="e.g., Buy groceries, Finish homework..."
                    required
                >
            </div>

            <!-- Due Date Input -->
            <div>
                <label for="todoDueDate" class="block text-sm font-medium text-black mb-2 font-hand">
                    Due Date (optional)
                </label>
                <input
                    type="date"
                    id="todoDueDate"
                    name="due_date"
                    class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans bg-white"
                >
            </div>
            
            <!-- Submit Button -->
            <button 
                type="submit"
                class="w-full sm:w-auto bg-black text-white px-6 sm:px-8 py-3 rounded-lg hover:bg-gray-800 focus:ring-2 focus:ring-black focus:ring-offset-2 transition-colors duration-200 font-hand font-bold text-base sm:text-lg"
            >
                <i class="fas fa-plus mr-2"></i>
                Add Todo
            </button>
        </form>
    </div>
    
    <!-- Todos List -->
    <div class="space-y-4">
        <!-- Filter Bar -->
        <div class="bg-white border-2 border-black rounded-lg shadow-lg p-4 sm:p-6">
            <form method="GET" action="/api/todos/" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-black mb-2 font-hand">Status</label>
                    <select id="statusFilter" name="status" class="w-full px-3 py-2 border-2 border-black rounded-lg bg-white font-sans">
                        <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All</option>
                        <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                </div>
                <div>
                    <label for="priorityFilter" class="block text-sm font-medium text-black mb-2 font-hand">Priority</label>
                    <select id="priorityFilter" name="priority" class="w-full px-3 py-2 border-2 border-black rounded-lg bg-white font-sans">
                        <option value="all" {% if selected_priority == 'all' %}selected{% endif %}>All</option>
                        <option value="3" {% if selected_priority == '3' %}selected{% endif %}>High</option>
                        <option value="2" {% if selected_priority == '2' %}selected{% endif %}>Medium</option>
                        <option value="1" {% if selected_priority == '1' %}selected{% endif %}>Low</option>
                    </select>
                </div>
                <button
                    type="button"
                    onclick="clearFilters()"
                    class="w-full sm:w-auto bg-black text-white px-5 py-2 rounded-lg hover:bg-gray-800 transition-colors duration-200 font-hand font-bold"
                >
                    Clear Filters
                </button>
            </form>
        </div>

        <h2 class="text-xl sm:text-2xl font-hand font-bold text-black mb-4">
            <i class="fas fa-tasks mr-2"></i>
            Your Todos
        </h2>
        
        <!-- Loading State (hidden by default) -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
            <p class="mt-2 text-black font-hand">Loading...</p>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12 bg-white border-2 border-black rounded-lg">
            <i class="fas fa-clipboard-list text-4xl text-black mb-4"></i>
            <h3 class="text-lg font-medium text-black mb-2 font-hand">No todos yet!</h3>
            <p class="text-black font-sans">Add your first todo above to get started.</p>
        </div>
        
        <!-- Todos Container -->
        <div id="todosContainer" class="space-y-3">
            {% for todo in todos %}
            <!-- Individual Todo Item -->
            <div class="todo-item bg-white border-2 border-black rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow duration-200" data-todo-id="{{ todo.id }}">
                <div class="flex items-start space-x-4">
                    <!-- Checkbox -->
                    <input 
                        type="checkbox" 
                        class="mt-1 w-5 h-5 rounded border-2 border-black text-black focus:ring-black cursor-pointer"
                        {% if todo.completed %}checked{% endif %}
                        onchange="toggleTodo({{ todo.id }}, this.checked)"
                    >
                    
                    <!-- Todo Content -->
                    <div class="flex-grow">
                        <!-- Display mode: Show the title as text -->
                        <div class="todo-display" id="todo-display-{{ todo.id }}">
                            <h3 class="text-base sm:text-lg font-hand font-bold text-black {% if todo.completed %}line-through text-gray-500{% endif %}">
                                {{ todo.title }}
                            </h3>
                            <p class="mt-1">
                                {% if todo.priority == 3 %}
                                    <span class="inline-block text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-800 border border-red-300">High Priority</span>
                                {% elif todo.priority == 2 %}
                                    <span class="inline-block text-xs font-bold px-2 py-1 rounded bg-blue-100 text-blue-800 border border-blue-300">Medium Priority</span>
                                {% else %}
                                    <span class="inline-block text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-800 border border-gray-300">Low Priority</span>
                                {% endif %}
                            </p>
                            <p class="text-xs text-gray-700 mt-1 font-sans">
                                {% if todo.due_date %}
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Due: {{ todo.due_date }}
                                {% else %}
                                    <i class="fas fa-calendar-times mr-1"></i>
                                    No due date
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Edit mode: Show input field (hidden by default) -->
                        <div class="todo-edit hidden" id="todo-edit-{{ todo.id }}">
                            <input 
                                type="text" 
                                id="todo-input-{{ todo.id }}"
                                value="{{ todo.title }}"
                                class="w-full px-3 py-2 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans"
                            >
                            <input
                                type="date"
                                id="todo-due-date-{{ todo.id }}"
                                value="{% if todo.due_date %}{{ todo.due_date }}{% endif %}"
                                class="mt-2 w-full px-3 py-2 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base font-sans bg-white"
                            >
                        </div>
                        
                        <p class="text-xs sm:text-sm text-gray-600 font-sans mt-1">
                            {% if todo.completed %}
                                <i class="fas fa-check-circle mr-1 text-green-600"></i>
                                Completed
                            {% else %}
                                <i class="fas fa-clock mr-1 text-yellow-600"></i>
                                Pending
                            {% endif %}
                        </p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-2">
                        <!-- Edit Button -->
                        <button 
                            onclick="startEdit({{ todo.id }})"
                            id="edit-btn-{{ todo.id }}"
                            class="text-blue-600 hover:text-blue-800 focus:ring-2 focus:ring-blue-500 rounded p-2 transition-colors"
                            title="Edit todo"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        
                        <!-- Save Button (hidden by default, shown during edit) -->
                        <button 
                            onclick="saveEdit({{ todo.id }})"
                            id="save-btn-{{ todo.id }}"
                            class="hidden text-green-600 hover:text-green-800 focus:ring-2 focus:ring-green-500 rounded p-2 transition-colors"
                            title="Save changes"
                        >
                            <i class="fas fa-check"></i>
                        </button>
                        
                        <!-- Cancel Button (hidden by default, shown during edit) -->
                        <button 
                            onclick="cancelEdit({{ todo.id }})"
                            id="cancel-btn-{{ todo.id }}"
                            class="hidden text-gray-600 hover:text-gray-800 focus:ring-2 focus:ring-gray-500 rounded p-2 transition-colors"
                            title="Cancel editing"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <!-- Delete Button -->
                        <button 
                            onclick="deleteTodo({{ todo.id }})"
                            class="text-red-600 hover:text-red-800 focus:ring-2 focus:ring-red-500 rounded p-2 transition-colors"
                            title="Delete todo"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    /**
     * API Base URL
     * This is the base URL for all API calls
     */
    const API_BASE_URL = '/api/todos';
    
    /**
     * Add a new todo
     * Handles form submission to create a new todo item
     */
    document.getElementById('todoForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent page reload
        
        // Get the input value
        const titleInput = document.getElementById('todoTitle');
        const dueDateInput = document.getElementById('todoDueDate');
        const title = titleInput.value.trim();
        const dueDate = dueDateInput.value || null;
        
        if (!title) {
            alert('Please enter a todo title');
            return;
        }
        
        try {
            // Send POST request to create the todo
            const response = await fetch(API_BASE_URL + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: title, due_date: dueDate })
            });
            
            if (!response.ok) {
                throw new Error('Failed to create todo');
            }
            
            // Clear the input and reload the page to show the new todo
            titleInput.value = '';
            dueDateInput.value = '';
            window.location.reload();
        } catch (error) {
            console.error('Error creating todo:', error);
            alert('Failed to create todo. Please try again.');
        }
    });
    
    /**
     * Toggle todo completion status
     * Updates whether a todo is completed or pending
     */
    async function toggleTodo(todoId, completed) {
        try {
            // Send PUT request to update the todo
            const response = await fetch(`${API_BASE_URL}/${todoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ completed: completed })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update todo');
            }
            
            // Reload the page to show the updated status
            window.location.reload();
        } catch (error) {
            console.error('Error updating todo:', error);
            alert('Failed to update todo. Please try again.');
        }
    }
    
    /**
     * Start editing a todo
     * Switches the todo display to edit mode and shows edit controls
     */
    function startEdit(todoId) {
        // Get the current title before hiding the display
        const displayDiv = document.getElementById(`todo-display-${todoId}`);
        const currentTitle = displayDiv.querySelector('h3').textContent.trim();
        
        // Store the original title in a data attribute for cancel functionality
        const input = document.getElementById(`todo-input-${todoId}`);
        const dueDateInput = document.getElementById(`todo-due-date-${todoId}`);
        input.setAttribute('data-original-title', currentTitle);
        dueDateInput.setAttribute('data-original-due-date', dueDateInput.value);
        
        // Hide the display (title text)
        displayDiv.classList.add('hidden');
        
        // Show the edit input
        const editDiv = document.getElementById(`todo-edit-${todoId}`);
        editDiv.classList.remove('hidden');
        
        // Hide edit button, show save and cancel buttons
        document.getElementById(`edit-btn-${todoId}`).classList.add('hidden');
        document.getElementById(`save-btn-${todoId}`).classList.remove('hidden');
        document.getElementById(`cancel-btn-${todoId}`).classList.remove('hidden');
        
        // Focus on the input field and select all text for easy editing
        input.focus();
        input.select();
        
        // Allow saving by pressing Enter
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEdit(todoId);
            }
        });
        
        // Allow canceling by pressing Escape
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cancelEdit(todoId);
            }
        });
    }
    
    /**
     * Save the edited todo
     * Updates the todo title in the database
     */
    async function saveEdit(todoId) {
        // Get the new title from the input field
        const input = document.getElementById(`todo-input-${todoId}`);
        const dueDateInput = document.getElementById(`todo-due-date-${todoId}`);
        const newTitle = input.value.trim();
        const newDueDate = dueDateInput.value || null;
        
        // Validate that the title is not empty
        if (!newTitle) {
            alert('Todo title cannot be empty');
            return;
        }
        
        try {
            // Send PUT request to update the todo title
            const response = await fetch(`${API_BASE_URL}/${todoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: newTitle, due_date: newDueDate })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update todo');
            }
            
            // Reload the page to show the updated todo
            window.location.reload();
        } catch (error) {
            console.error('Error updating todo:', error);
            alert('Failed to update todo. Please try again.');
        }
    }
    
    /**
     * Cancel editing
     * Returns the todo to display mode without saving changes
     */
    function cancelEdit(todoId) {
        // Get the original title from the data attribute we stored
        const input = document.getElementById(`todo-input-${todoId}`);
        const dueDateInput = document.getElementById(`todo-due-date-${todoId}`);
        const originalTitle = input.getAttribute('data-original-title');
        const originalDueDate = dueDateInput.getAttribute('data-original-due-date');
        
        // Reset the input to the original value
        input.value = originalTitle;
        dueDateInput.value = originalDueDate;
        
        // Show the display, hide the edit input
        const displayDiv = document.getElementById(`todo-display-${todoId}`);
        displayDiv.classList.remove('hidden');
        document.getElementById(`todo-edit-${todoId}`).classList.add('hidden');
        
        // Show edit button, hide save and cancel buttons
        document.getElementById(`edit-btn-${todoId}`).classList.remove('hidden');
        document.getElementById(`save-btn-${todoId}`).classList.add('hidden');
        document.getElementById(`cancel-btn-${todoId}`).classList.add('hidden');
    }
    
    /**
     * Delete a todo
     * Removes a todo item from the list
     */
    async function deleteTodo(todoId) {
        // Confirm before deleting
        if (!confirm('Are you sure you want to delete this todo?')) {
            return;
        }
        
        try {
            // Send DELETE request
            const response = await fetch(`${API_BASE_URL}/${todoId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete todo');
            }
            
            // Reload the page to show the updated list
            window.location.reload();
        } catch (error) {
            console.error('Error deleting todo:', error);
            alert('Failed to delete todo. Please try again.');
        }
    }
    
    /**
     * Show/hide empty state based on todos count
     * This function is called when the page loads
     */
    window.addEventListener('DOMContentLoaded', () => {
        const todosContainer = document.getElementById('todosContainer');
        const emptyState = document.getElementById('emptyState');
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        
        // Check if there are any todos
        const todoItems = todosContainer.querySelectorAll('.todo-item');
        if (todoItems.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }

        // Apply filters immediately when dropdown changes
        statusFilter.addEventListener('change', () => statusFilter.form.submit());
        priorityFilter.addEventListener('change', () => priorityFilter.form.submit());
    });

    /**
     * Clear all active filters and reload the full todo list.
     */
    function clearFilters() {
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        statusFilter.value = 'all';
        priorityFilter.value = 'all';
        statusFilter.form.submit();
    }
</script>
{% endblock %}
